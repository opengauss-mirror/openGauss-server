-- test for insert/update ignore.
create database sql_ignore_not_null_test dbcompatibility 'B';
\c sql_ignore_not_null_test;
drop table if exists t_ignore;
NOTICE:  table "t_ignore" does not exist, skipping
create table t_ignore(col1 int, col2 int not null, col3 varchar not null);
-- sqlbypass
set enable_opfusion = on;
-- test for condition without ignore
insert into t_ignore values(1, 1, 'abcdef');
insert into t_ignore values(1, null, null);
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
insert into t_ignore values(1, null, 'abcdef');
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, abcdef).
insert into t_ignore values(1, 1, null);
ERROR:  null value in column "col3" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null).
insert into t_ignore values(1, null, null);
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |  col3  
------+------+--------
    1 |    1 | abcdef
(1 row)

update t_ignore set col2 = null, col3 = null;
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |  col3  
------+------+--------
    1 |    1 | abcdef
(1 row)

-- test for condition with ignore
insert /*+ ignore_error */ into t_ignore values(1, 1, 'abcdef');
explain(costs off) insert /*+ ignore_error */ into t_ignore values(1, null, null);
     QUERY PLAN     
--------------------
 [Bypass]
 Insert on t_ignore
   ->  Result
(3 rows)

insert /*+ ignore_error */ into t_ignore values(1, null, null);
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
insert /*+ ignore_error */ into t_ignore values(1, null, 'abcdef');
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, abcdef).
insert /*+ ignore_error */ into t_ignore values(1, 1, null);
WARNING:  null value in column "col3" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null).
insert /*+ ignore_error */ into t_ignore values(1, null, null);
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |  col3  
------+------+--------
    1 |    1 | abcdef
    1 |    1 | abcdef
(2 rows)

update /*+ ignore_error */ t_ignore set col2 = null, col3 = null;
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |  col3  
------+------+--------
    1 |    1 | abcdef
    1 |    1 | abcdef
(2 rows)

-- insert ignore from other tables with null
drop table if exists t_from;
NOTICE:  table "t_from" does not exist, skipping
create table t_from (col1 int, col2 int, col3 varchar);
insert into t_from values(9,9,'row from others');
insert into t_from values(1, null, null);
insert /*+ ignore_error */ into t_ignore select * from t_from;
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
(3 rows)

-- test for null replacement
set sql_ignore_strategy = 'overwrite_null';
explain(costs off) insert /*+ ignore_error */ into t_ignore values(1, null, null);
     QUERY PLAN     
--------------------
 [Bypass]
 Insert on t_ignore
   ->  Result
(3 rows)

insert /*+ ignore_error */ into t_ignore values(1, null, null);
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
(4 rows)

set sql_ignore_strategy = 'ignore_null';
-- no bypass
set enable_opfusion = off;
-- test for condition without ignore
insert into t_ignore values(1, 1, 'abcdef');
insert into t_ignore values(1, null, null);
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
insert into t_ignore values(1, null, 'abcdef');
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, abcdef).
insert into t_ignore values(1, 1, null);
ERROR:  null value in column "col3" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null).
insert into t_ignore values(1, null, null);
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
    1 |    1 | abcdef
(5 rows)

update t_ignore set col2 = null, col3 = null;
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
    1 |    1 | abcdef
(5 rows)

-- test for condition with ignore
insert /*+ ignore_error */ into t_ignore values(1, 1, 'abcdef');
explain(costs off) insert /*+ ignore_error */ into t_ignore values(1, null, null);
     QUERY PLAN     
--------------------
 Insert on t_ignore
   ->  Result
(2 rows)

insert /*+ ignore_error */ into t_ignore values(1, null, null);
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
insert /*+ ignore_error */ into t_ignore values(1, null, 'abcdef');
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, abcdef).
insert /*+ ignore_error */ into t_ignore values(1, 1, null);
WARNING:  null value in column "col3" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null).
insert /*+ ignore_error */ into t_ignore values(1, null, null);
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
    1 |    1 | abcdef
    1 |    1 | abcdef
(6 rows)

update t_ignore set col2 = null, col3 = null;
ERROR:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
    1 |    1 | abcdef
    1 |    1 | abcdef
(6 rows)

-- insert ignore from other tables with null
insert /*+ ignore_error */ into t_ignore select * from t_from;
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
(7 rows)

-- test for null replacement
set sql_ignore_strategy = 'overwrite_null';
explain(costs off) insert /*+ ignore_error */ into t_ignore values(1, null, null);
     QUERY PLAN     
--------------------
 Insert on t_ignore
   ->  Result
(2 rows)

insert /*+ ignore_error */ into t_ignore values(1, null, null);
WARNING:  null value in column "col2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null).
select * from t_ignore;
 col1 | col2 |      col3       
------+------+-----------------
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
    1 |    1 | abcdef
    1 |    1 | abcdef
    9 |    9 | row from others
    1 |    0 | 
(8 rows)

set sql_ignore_strategy = 'ignore_null';
-- test for overwriting null into "zero" of specific type
set sql_ignore_strategy = 'overwrite_null';
-- timestamp
create table t_timestamp(c timestamp not null);
insert /*+ ignore_error */ into t_timestamp values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_timestamp;
--?.*
--?.*
--?.*
(1 row)

insert into t_timestamp values('2022-06-01 17:26:59.846448');
update /*+ ignore_error */ t_timestamp set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_timestamp;
--?.*
--?.*
--?.*
--?.*
(2 rows)

-- timetz
create table t_timetz(c timetz not null);
set timezone to 'PRC';
insert /*+ ignore_error */ into t_timetz values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_timetz;
      c      
-------------
 00:00:00+08
(1 row)

insert into t_timetz values('00:00:01+08');
update /*+ ignore_error */ t_timetz set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_timetz;
      c      
-------------
 00:00:00+08
 00:00:00+08
(2 rows)

reset timezone;
show timezone;
 TimeZone 
----------
 PST8PDT
(1 row)

-- time
create table t_time(c time not null);
insert /*+ ignore_error */ into t_time values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_time;
    c     
----------
 00:00:00
(1 row)

insert into t_time values('00:00:00');
update /*+ ignore_error */ t_time set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_time;
    c     
----------
 00:00:00
 00:00:00
(2 rows)

-- interval
create table t_interval(c interval not null);
insert /*+ ignore_error */ into t_interval values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_interval;
  c  
-----
 @ 0
(1 row)

insert into t_interval values('00:00:01');
update /*+ ignore_error */ t_interval set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_interval;
  c  
-----
 @ 0
 @ 0
(2 rows)

-- tinterval
create table t_tinterval(c tinterval not null);
insert /*+ ignore_error */ into t_tinterval values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_tinterval;
                                c                                
-----------------------------------------------------------------
 ["Thu Jan 01 00:00:00 1970 PST" "Thu Jan 01 00:00:00 1970 PST"]
(1 row)

update /*+ ignore_error */ t_tinterval set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_tinterval;
                                c                                
-----------------------------------------------------------------
 ["Thu Jan 01 00:00:00 1970 PST" "Thu Jan 01 00:00:00 1970 PST"]
(1 row)

-- smalldatetime
create table t_smalldatetime(c smalldatetime not null);
insert /*+ ignore_error */ into t_smalldatetime values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_smalldatetime;
            c             
--------------------------
 Thu Jan 01 00:00:00 1970
(1 row)

insert into t_smalldatetime values('1991-01-01 08:00:00');
update /*+ ignore_error */ t_smalldatetime set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_smalldatetime;
            c             
--------------------------
 Thu Jan 01 00:00:00 1970
 Thu Jan 01 00:00:00 1970
(2 rows)

-- date
create table t_date(c date not null);
insert /*+ ignore_error */ into t_date values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_date;
     c      
------------
 01-01-1970
(1 row)

insert into t_date values('1991-01-01 08:00:00');
update /*+ ignore_error */ t_date set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_date;
     c      
------------
 01-01-1970
 01-01-1970
(2 rows)

-- uuid
create table t_uuid(c uuid not null);
insert /*+ ignore_error */ into t_uuid values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_uuid;
                  c                   
--------------------------------------
 00000000-0000-0000-0000-000000000000
(1 row)

insert into t_uuid values('aaaaaaaa-0000-0000-0000-000000000000');
update /*+ ignore_error */ t_uuid set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_uuid;
                  c                   
--------------------------------------
 00000000-0000-0000-0000-000000000000
 00000000-0000-0000-0000-000000000000
(2 rows)

-- name
create table t_name(c name not null);
insert /*+ ignore_error */ into t_name values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_name;
 c 
---
 
(1 row)

insert into t_name values('abc');
update /*+ ignore_error */ t_name set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_name;
 c 
---
 
 
(2 rows)

-- point
create table t_point(c point not null);
insert /*+ ignore_error */ into t_point values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_point;
   c   
-------
 (0,0)
(1 row)

insert into t_point values('(1,1)');
update /*+ ignore_error */ t_point set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_point;
   c   
-------
 (0,0)
 (0,0)
(2 rows)

-- path
create table t_path(c path not null);
insert /*+ ignore_error */ into t_path values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_path;
    c    
---------
 ((0,0))
(1 row)

insert into t_path values('((1,1))');
update /*+ ignore_error */ t_path set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_path;
    c    
---------
 ((0,0))
 ((0,0))
(2 rows)

-- polygon
create table t_polygon(c polygon not null);
insert /*+ ignore_error */ into t_polygon values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_polygon;
    c    
---------
 ((0,0))
(1 row)

insert into t_polygon values('((1,1))');
update /*+ ignore_error */ t_polygon set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_polygon;
    c    
---------
 ((0,0))
 ((0,0))
(2 rows)

-- circle
create table t_circle(c circle not null);
insert /*+ ignore_error */ into t_circle values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_circle;
     c     
-----------
 <(0,0),0>
(1 row)

insert into t_circle values('<(1,1),1>');
update /*+ ignore_error */ t_circle set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_circle;
     c     
-----------
 <(0,0),0>
 <(0,0),0>
(2 rows)

-- box
create table t_box(c box not null);
insert /*+ ignore_error */ into t_box values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_box;
      c      
-------------
 (0,0),(0,0)
(1 row)

insert into t_box values('(1,1),(2,2)');
update /*+ ignore_error */ t_box set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_box;
      c      
-------------
 (0,0),(0,0)
 (0,0),(0,0)
(2 rows)

-- json
create table t_json(c json not null);
insert /*+ ignore_error */ into t_json values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_json;
  c   
------
 null
(1 row)

insert into t_json values('111');
update /*+ ignore_error */ t_json set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_json;
  c   
------
 null
 null
(2 rows)

select * from t_json where c::text = 'null';
  c   
------
 null
 null
(2 rows)

-- jsonb
create table t_jsonb(c jsonb not null);
insert /*+ ignore_error */ into t_jsonb values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_jsonb;
  c   
------
 null
(1 row)

insert into t_jsonb values('111');
update /*+ ignore_error */ t_jsonb set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_jsonb;
  c   
------
 null
 null
(2 rows)

select * from t_jsonb where c::text = 'null';
  c   
------
 null
 null
(2 rows)

-- bit
create table t_bit(c bit not null);
insert /*+ ignore_error */ into t_bit values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_bit;
 c 
---
 
(1 row)

insert into t_bit values('1');
update /*+ ignore_error */ t_bit set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_bit;
 c 
---
 
 
(2 rows)

-- tinyint
create table t_tinyint(c tinyint not null);
insert /*+ ignore_error */ into t_tinyint values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_tinyint;
 c 
---
 0
(1 row)

insert into t_tinyint values('10');
update /*+ ignore_error */ t_tinyint set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_tinyint;
 c 
---
 0
 0
(2 rows)

-- smallint
create table t_smallint(c smallint not null);
insert /*+ ignore_error */ into t_smallint values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_smallint;
 c 
---
 0
(1 row)

insert into t_smallint values('123');
update /*+ ignore_error */ t_smallint set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_smallint;
 c 
---
 0
 0
(2 rows)

-- int
create table t_int(c int not null);
insert /*+ ignore_error */ into t_int values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_int;
 c 
---
 0
(1 row)

insert into t_int values(9999);
update /*+ ignore_error */ t_int set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_int;
 c 
---
 0
 0
(2 rows)

-- bigint
create table t_bigint(c bigint not null);
insert /*+ ignore_error */ into t_bigint values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_bigint;
 c 
---
 0
(1 row)

insert into t_bigint values(9999999999999999);
update /*+ ignore_error */ t_bigint set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_bigint;
 c 
---
 0
 0
(2 rows)

-- float
create table t_float(c float not null);
insert /*+ ignore_error */ into t_float values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_float;
 c 
---
 0
(1 row)

insert into t_float values(123.99);
update /*+ ignore_error */ t_float set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_float;
 c 
---
 0
 0
(2 rows)

-- float8
create table t_float8(c float8 not null);
insert /*+ ignore_error */ into t_float8 values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_float8;
 c 
---
 0
(1 row)

insert into t_float8 values(123.99);
update /*+ ignore_error */ t_float8 set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_float8;
 c 
---
 0
 0
(2 rows)

-- numeric
create table t_numeric(c numeric not null);
insert /*+ ignore_error */ into t_numeric values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_numeric;
 c 
---
 0
(1 row)

insert into t_numeric values(123.99);
update /*+ ignore_error */ t_numeric set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_numeric;
 c 
---
 0
 0
(2 rows)

-- serial
create table t_serial(c serial not null);
NOTICE:  CREATE TABLE will create implicit sequence "t_serial_c_seq" for serial column "t_serial.c"
insert /*+ ignore_error */ into t_serial values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_serial;
 c 
---
 0
(1 row)

insert into t_serial values(123);
update /*+ ignore_error */ t_serial set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_serial;
 c 
---
 0
 0
(2 rows)

-- bool
create table t_bool(c bool not null);
insert /*+ ignore_error */ into t_bool values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_bool;
 c 
---
 f
(1 row)

insert into t_bool values(true);
update /*+ ignore_error */ t_bool set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_bool;
 c 
---
 f
 f
(2 rows)

-- char(n)
create table t_charn(c char(6) not null);
insert /*+ ignore_error */ into t_charn values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_charn;
 c 
---
 
(1 row)

insert into t_charn values('abc');
update /*+ ignore_error */ t_charn set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_charn;
 c 
---
 
 
(2 rows)

-- varchar(n)
create table t_varcharn(c varchar(6) not null);
insert /*+ ignore_error */ into t_varcharn values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_varcharn;
 c 
---
 
(1 row)

insert into t_varcharn values('xxxxxx');
update /*+ ignore_error */ t_varcharn set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_varcharn;
 c 
---
 
 
(2 rows)

-- text
create table t_text(c text not null);
insert /*+ ignore_error */ into t_text values (null);
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_text;
 c 
---
 
(1 row)

insert into t_text values('xxxxxx');
update /*+ ignore_error */ t_text set c = null;
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
WARNING:  null value in column "c" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_text;
 c 
---
 
 
(2 rows)

-- mixture
drop table if exists t_mix;
NOTICE:  table "t_mix" does not exist, skipping
create table t_mix
(
    c1 int,
    c2 bigint     not null,
    c3 varchar(6) not null,
    c4 bool       not null
);
insert /*+ ignore_error */ into t_mix values(1, null, null, null);
WARNING:  null value in column "c2" violates not-null constraint
DETAIL:  Failing row contains (1, null, null, null).
insert /*+ ignore_error */ into t_mix values(2, 2, null, null);
WARNING:  null value in column "c3" violates not-null constraint
DETAIL:  Failing row contains (2, 2, null, null).
select * from t_mix;
 c1 | c2 | c3 | c4 
----+----+----+----
  1 |  0 |    | f
  2 |  2 |    | f
(2 rows)

insert into t_mix values(2, 2, 'abced', true);
update /*+ ignore_error */ t_mix set c1 = 9, c2 = null, c3 = null, c4 = null;
WARNING:  null value in column "c2" violates not-null constraint
DETAIL:  Failing row contains (9, null, null, null).
WARNING:  null value in column "c2" violates not-null constraint
DETAIL:  Failing row contains (9, null, null, null).
WARNING:  null value in column "c2" violates not-null constraint
DETAIL:  Failing row contains (9, null, null, null).
select * from t_mix;
 c1 | c2 | c3 | c4 
----+----+----+----
  9 |  0 |    | f
  9 |  0 |    | f
  9 |  0 |    | f
(3 rows)

drop table if exists t_mix;
-- test for mixture of not null constraints and check constraints
create table t_mix(num int not null check(num > 5));
set sql_ignore_strategy = 'overwrite_null';
set enable_opfusion = on;
insert /*+ ignore_error */ into t_mix values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
ERROR:  new row for relation "t_mix" violates check constraint "t_mix_num_check"
DETAIL:  N/A
select * from t_mix;
 num 
-----
(0 rows)

set enable_opfusion = off;
insert /*+ ignore_error */ into t_mix values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
ERROR:  new row for relation "t_mix" violates check constraint "t_mix_num_check"
DETAIL:  N/A
select * from t_mix;
 num 
-----
(0 rows)

drop table if exists t_mix;
create table t_mix(num int not null check(num > -5));
set sql_ignore_strategy = 'overwrite_null';
set enable_opfusion = on;
insert /*+ ignore_error */ into t_mix values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_mix;
 num 
-----
   0
(1 row)

set enable_opfusion = off;
insert /*+ ignore_error */ into t_mix values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_mix;
 num 
-----
   0
   0
(2 rows)

drop table if exists t_mix;
create table t_mix(content text not null check(length(content) > 5));
set sql_ignore_strategy = 'overwrite_null';
set enable_opfusion = on;
insert /*+ ignore_error */ into t_mix values(null);
WARNING:  null value in column "content" violates not-null constraint
DETAIL:  Failing row contains (null).
ERROR:  new row for relation "t_mix" violates check constraint "t_mix_content_check"
DETAIL:  N/A
select * from t_mix;
 content 
---------
(0 rows)

set enable_opfusion = off;
insert /*+ ignore_error */ into t_mix values(null);
WARNING:  null value in column "content" violates not-null constraint
DETAIL:  Failing row contains (null).
ERROR:  new row for relation "t_mix" violates check constraint "t_mix_content_check"
DETAIL:  N/A
select * from t_mix;
 content 
---------
(0 rows)

drop table if exists t_mix;
-- test for partition table with not null constraint
-- opfusion: on
set enable_opfusion = on;
set enable_partition_opfusion = on;
drop table if exists t_not_null_key_partition;
NOTICE:  table "t_not_null_key_partition" does not exist, skipping
CREATE TABLE t_not_null_key_partition
(
    num     integer NOT NULL,
    ca_city character varying(60)
) PARTITION BY RANGE (num)
(
    PARTITION P1 VALUES LESS THAN(5000),
    PARTITION P2 VALUES LESS THAN(10000),
    PARTITION P3 VALUES LESS THAN(15000),
    PARTITION P4 VALUES LESS THAN(20000),
    PARTITION P5 VALUES LESS THAN(25000),
    PARTITION P6 VALUES LESS THAN(30000),
    PARTITION P7 VALUES LESS THAN(40000)
);
insert into t_not_null_key_partition values(1, 'shenzhen');
select * from t_not_null_key_partition;
 num | ca_city  
-----+----------
   1 | shenzhen
(1 row)

set sql_ignore_strategy = 'ignore_null';
explain(costs off) insert /*+ ignore_error */ into  t_not_null_key_partition values (null);
             QUERY PLAN             
------------------------------------
 [Bypass]
 Insert on t_not_null_key_partition
   ->  Result
(3 rows)

insert /*+ ignore_error */ into  t_not_null_key_partition values (null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null, null).
select * from t_not_null_key_partition;
 num | ca_city  
-----+----------
   1 | shenzhen
(1 row)

update /*+ ignore_error */ t_not_null_key_partition set num = null;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null, shenzhen).
select * from t_not_null_key_partition;
 num | ca_city  
-----+----------
   1 | shenzhen
(1 row)

-- opfusion: off
set enable_opfusion = off;
set enable_partition_opfusion = off;
set sql_ignore_strategy = 'overwrite_null';
insert /*+ ignore_error */ into  t_not_null_key_partition values (null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null, null).
select * from t_not_null_key_partition;
 num | ca_city  
-----+----------
   1 | shenzhen
   0 | 
(2 rows)

update /*+ ignore_error */ t_not_null_key_partition set num = null;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null, shenzhen).
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null, null).
select * from t_not_null_key_partition;
 num | ca_city  
-----+----------
   0 | shenzhen
   0 | 
(2 rows)

-- test for subpartition table
drop table if exists ignore_range_range;
NOTICE:  table "ignore_range_range" does not exist, skipping
CREATE TABLE ignore_range_range
(
    month_code VARCHAR2 ( 30 ) NOT NULL ,
    dept_code  int NOT NULL ,
    user_no    VARCHAR2 ( 30 ) NOT NULL ,
    sales_amt  int
)
    PARTITION BY RANGE (month_code) SUBPARTITION BY RANGE (dept_code)
(
  PARTITION p_201901 VALUES LESS THAN( '201901' )
  (
    SUBPARTITION p_201901_a VALUES LESS THAN( -5 ),
    SUBPARTITION p_201901_b VALUES LESS THAN( 1 )
  ),
  PARTITION p_201902 VALUES LESS THAN( '201902' )
  (
    SUBPARTITION p_201902_a VALUES LESS THAN( -5 ),
    SUBPARTITION p_201902_b VALUES LESS THAN( 1 )
  )
);
-- opfusion: on
set enable_opfusion = on;
set enable_partition_opfusion = on;
-- sql_ignore_strategy: ignore_null
set sql_ignore_strategy = 'ignore_null';
insert /*+ ignore_error */  into ignore_range_range values('201901', null, '1', 1);
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
(0 rows)

insert into ignore_range_range values('201901', -3, '1', 1);
update /*+ ignore_error */ ignore_range_range set dept_code = null where dept_code = -3;
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
 201901     |        -3 | 1       |         1
(1 row)

-- sql_ignore_strategy: overwrite_null
delete from ignore_range_range;
set sql_ignore_strategy = 'overwrite_null';
insert /*+ ignore_error */  into ignore_range_range values('201901', null, '1', 1);
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
 201901     |         0 | 1       |         1
(1 row)

insert into ignore_range_range values('201901', -3, '1', 1);
update /*+ ignore_error */ ignore_range_range set dept_code = null where dept_code = -3;
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
 201901     |         0 | 1       |         1
 201901     |         0 | 1       |         1
(2 rows)

-- opfusion: off
set enable_opfusion = off;
set enable_partition_opfusion = off;
-- sql_ignore_strategy: ignore_null
set sql_ignore_strategy = 'ignore_null';
delete from ignore_range_range;
insert /*+ ignore_error */  into ignore_range_range values('201901', null, '1', 1);
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
(0 rows)

insert into ignore_range_range values('201901', -3, '1', 1);
update /*+ ignore_error */ ignore_range_range set dept_code = null where dept_code = -3;
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
 201901     |        -3 | 1       |         1
(1 row)

-- sql_ignore_strategy: overwrite_null
set sql_ignore_strategy = 'overwrite_null';
delete from ignore_range_range;
insert /*+ ignore_error */  into ignore_range_range values('201901', null, '1', 1);
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
 201901     |         0 | 1       |         1
(1 row)

insert into ignore_range_range values('201901', -3, '1', 1);
update /*+ ignore_error */ ignore_range_range set dept_code = null where dept_code = -3;
WARNING:  null value in column "dept_code" violates not-null constraint
DETAIL:  Failing row contains (201901, null, 1, 1).
select * from ignore_range_range;
 month_code | dept_code | user_no | sales_amt 
------------+-----------+---------+-----------
 201901     |         0 | 1       |         1
 201901     |         0 | 1       |         1
(2 rows)

delete from ignore_range_range;
-- test for ustore table
drop table if exists t_ignore;
create table t_ignore(num int not null) with (storage_type = ustore);
-- opfusion: on
set enable_opfusion = on;
set sql_ignore_strategy = 'ignore_null';
explain(costs off) insert /*+ ignore_error */ into t_ignore values(null);
     QUERY PLAN     
--------------------
 [Bypass]
 Insert on t_ignore
   ->  Result
(3 rows)

insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
(0 rows)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   1
(1 row)

delete from t_ignore;
set sql_ignore_strategy = 'overwrite_null';
insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
(1 row)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
   0
(2 rows)

-- opfusion: off
delete from t_ignore;
set enable_opfusion = off;
set sql_ignore_strategy = 'ignore_null';
explain(costs off) insert /*+ ignore_error */ into t_ignore values(null);
     QUERY PLAN     
--------------------
 Insert on t_ignore
   ->  Result
(2 rows)

insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
(0 rows)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   1
(1 row)

delete from t_ignore;
set sql_ignore_strategy = 'overwrite_null';
insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
(1 row)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
   0
(2 rows)

-- test for segment table
drop table if exists t_ignore;
create table t_ignore(num int not null) with (segment = on);
-- test for segment table, opfusion: on
set enable_opfusion = on;
set sql_ignore_strategy = 'ignore_null';
explain(costs off) insert /*+ ignore_error */ into t_ignore values(null);
     QUERY PLAN     
--------------------
 [Bypass]
 Insert on t_ignore
   ->  Result
(3 rows)

insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
(0 rows)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   1
(1 row)

set sql_ignore_strategy = 'overwrite_null';
delete from t_ignore;
insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
(1 row)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
   0
(2 rows)

-- test for segment table, opfusion: off
set enable_opfusion = off;
set sql_ignore_strategy = 'ignore_null';
delete from t_ignore;
explain(costs off) insert /*+ ignore_error */ into t_ignore values(null);
     QUERY PLAN     
--------------------
 Insert on t_ignore
   ->  Result
(2 rows)

insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
(0 rows)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   1
(1 row)

set sql_ignore_strategy = 'overwrite_null';
delete from t_ignore;
insert /*+ ignore_error */ into t_ignore values(null);
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
(1 row)

insert into t_ignore values(1);
update /*+ ignore_error */ t_ignore set num = null where num = 1;
WARNING:  null value in column "num" violates not-null constraint
DETAIL:  Failing row contains (null).
select * from t_ignore;
 num 
-----
   0
   0
(2 rows)

-- restore context
\c postgres
drop database if exists sql_ignore_not_null_test;
